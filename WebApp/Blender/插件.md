bl_info = {
    "name" : "Alignment",
    "description" : "一个快速对齐的插件",
    "author" : "",
    "version" : (0, 0, 1),
    "blender" : (2, 80, 0),
    "location" : "View3D",
    "warning" : "",
    "support" : "COMMUNITY",
    "doc_url" : "",
    "category" : "3D View"
}

import bpy
from bpy.types import Operator
from bpy.types import Panel
import bmesh
from mathutils import Vector

def align(value):
    l = bpy.context.scene.cursor.location
    o = bpy.context.object
    center = o.matrix_world @ (0.125 * sum((Vector(b) for b in o.bound_box), Vector()))
    corners = [ bpy.context.object.matrix_world @ Vector(corner) for corner in  bpy.context.object.bound_box] 
    parent = o.parent
    if parent is None:
        parent=o
    elif parent.parent is not None:
        parent=parent.parent
    o.select_set(False)
    parent.select_set(True)
    bpy.context.view_layer.objects.active = parent
    if value == 1:
        x = l.x-min([v.x for v in corners])
        bpy.ops.transform.translate(value=(x,0,0))
    elif value==2:
        x =l.x-center.x
        bpy.ops.transform.translate(value=(x,0,0))
    elif value==3:
        x =l.x-max([v.x for v in corners])
        bpy.ops.transform.translate(value=(x,0,0))
    elif value == 4:
        y = l.y-min([v.y for v in corners])
        bpy.ops.transform.translate(value=(0,y,0))
    elif value==5:
        y =l.y-center.y
        bpy.ops.transform.translate(value=(0,y,0))
    elif value==6:
        y =l.y-max([v.y for v in corners])
        bpy.ops.transform.translate(value=(0,y,0))
    elif value == 7:
        z = l.z-min([v.z for v in corners])
        bpy.ops.transform.translate(value=(0,0,z))
    elif value==8:
        z =l.z-center.z
        bpy.ops.transform.translate(value=(0,0,z))
    elif value==9:
        z =l.z-max([v.z for v in corners])
        bpy.ops.transform.translate(value=(0,0,z))

    return None

class _align_n_x(Operator):
    """ Align a group object by select object """
    bl_idname = "align.nx"
    bl_label = ""
    bl_options = {"REGISTER", "UNDO"}

    @classmethod
    def poll(cls, context):
        return context.mode == "OBJECT"

    def execute(self, context):
        align(1)
        return {'FINISHED'}

class _align_x(Operator):
    """ Align a group object by select object """
    bl_idname = "align.x"
    bl_label = ""
    bl_options = {"REGISTER", "UNDO"}

    @classmethod
    def poll(cls, context):
        return context.mode == "OBJECT"

    def execute(self, context):
        align(2)
        return {'FINISHED'}
    
class _align_p_x(Operator):
    """ Align a group object by select object """
    bl_idname = "align.px"
    bl_label = ""
    bl_options = {"REGISTER", "UNDO"}

    @classmethod
    def poll(cls, context):
        return context.mode == "OBJECT"

    def execute(self, context):
        align(3)
        return {'FINISHED'}

class _align_n_y(Operator):
    """ Align a group object by select object """
    bl_idname = "align.ny"
    bl_label = ""
    bl_options = {"REGISTER", "UNDO"}

    @classmethod
    def poll(cls, context):
        return context.mode == "OBJECT"

    def execute(self, context):
        align(4)
        return {'FINISHED'}

class _align_y(Operator):
    """ Align a group object by select object """
    bl_idname = "align.y"
    bl_label = ""
    bl_options = {"REGISTER", "UNDO"}

    @classmethod
    def poll(cls, context):
        return context.mode == "OBJECT"

    def execute(self, context):
        align(5)
        return {'FINISHED'}
    
class _align_p_y(Operator):
    """ Align a group object by select object """
    bl_idname = "align.py"
    bl_label = ""
    bl_options = {"REGISTER", "UNDO"}

    @classmethod
    def poll(cls, context):
        return context.mode == "OBJECT"

    def execute(self, context):
        align(6)
        return {'FINISHED'}

class _align_n_z(Operator):
    """ Align a group object by select object """
    bl_idname = "align.nz"
    bl_label = ""
    bl_options = {"REGISTER", "UNDO"}

    @classmethod
    def poll(cls, context):
        return context.mode == "OBJECT"

    def execute(self, context):
        align(7)
        return {'FINISHED'}

class _align_z(Operator):
    """ Align a group object by select object """
    bl_idname = "align.z"
    bl_label = ""
    bl_options = {"REGISTER", "UNDO"}

    @classmethod
    def poll(cls, context):
        return context.mode == "OBJECT"

    def execute(self, context):
        align(8)
        return {'FINISHED'}
    
class _align_p_z(Operator):
    """ Align a group object by select object """
    bl_idname = "align.pz"
    bl_label = ""
    bl_options = {"REGISTER", "UNDO"}

    @classmethod
    def poll(cls, context):
        return context.mode == "OBJECT"

    def execute(self, context):
        align(9)
        return {'FINISHED'}

class _modifier_mirror(Operator):
    """ Quick add modifier """
    bl_idname = "modifier.mirror"
    bl_label = ""
    bl_options = {"REGISTER", "UNDO"}

    @classmethod
    def poll(cls, context):
        return context.mode == "OBJECT" or context.mode == "EDIT_MESH"

    def execute(self, context):
        bpy.ops.object.modifier_add(type='MIRROR')
        return {'FINISHED'}

class _modifier_bevel(Operator):
    """ Quick add modifier """
    bl_idname = "modifier.bevel"
    bl_label = ""
    bl_options = {"REGISTER", "UNDO"}

    @classmethod
    def poll(cls, context):
        return context.mode == "OBJECT" or context.mode == "EDIT_MESH"

    def execute(self, context):
        bpy.ops.object.modifier_add(type='BEVEL')
        bpy.context.object.modifiers["Bevel"].width = 0.018
        bpy.context.object.modifiers["Bevel"].segments = 2
        bpy.context.object.modifiers["Bevel"].miter_outer = 'MITER_ARC'
        bpy.context.object.modifiers["Bevel"].harden_normals = True
        return {'FINISHED'}

class _modifier_solidify(Operator):
    """ Quick add modifier """
    bl_idname = "modifier.solidify"
    bl_label = ""
    bl_options = {"REGISTER", "UNDO"}

    @classmethod
    def poll(cls, context):
        return context.mode == "OBJECT" or context.mode == "EDIT_MESH"

    def execute(self, context):
        bpy.ops.object.modifier_add(type='SOLIDIFY')
        return {'FINISHED'}
      
class _align(Panel):
    """将所选对象和其所在的组与光标对齐"""
    bl_label = "对齐"
    bl_space_type = "VIEW_3D"
    bl_region_type = "UI"
    bl_category = "对齐"

    def draw(self, context):
        row = self.layout.row(align=True)
        row.operator(_align_n_x.bl_idname, text="-X")
        row.operator(_align_x.bl_idname, text="X")
        row.operator(_align_p_x.bl_idname, text="+X")
        row = self.layout.row(align=True)
        row.operator(_align_n_y.bl_idname, text="-Y")
        row.operator(_align_y.bl_idname, text="Y")
        row.operator(_align_p_y.bl_idname, text="+Y")
        row = self.layout.row(align=True)
        row.operator(_align_n_z.bl_idname, text="-Z")
        row.operator(_align_z.bl_idname, text="Z")
        row.operator(_align_p_z.bl_idname, text="+Z")
        row = self.layout.row(align=True)
        row.operator(_modifier_mirror.bl_idname, text="Mirror")
        row.operator(_modifier_bevel.bl_idname, text="Bevel")
        row.operator(_modifier_solidify.bl_idname, text="Solidify")

classes = [
    _align_n_x,
    _align_x,
    _align_p_x,
    _align_n_y,
    _align_y,
    _align_p_y,
    _align_n_z,
    _align_z,
    _align_p_z,
    _modifier_mirror,
    _modifier_bevel,
    _modifier_solidify,
    _align,
]

def register():
    for c in classes:
        bpy.utils.register_class(c)


def unregister():
    for c in classes:
        bpy.utils.unregister_class(c)


if __name__ == '__main__':
    register()